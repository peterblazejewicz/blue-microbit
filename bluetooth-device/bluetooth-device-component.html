<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="bluetooth-device-component">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Hello [[prop1]]!</h2>
  </template>

  <script>
    (() => {
        let SUPPORTED = 'bluetooth' in navigator;
        if(!['BluetoothDevice'] in window){
            window.BluetoothDevice = {};
        }
        /**
        * `bluetooth-device-component`
        * Bluetooth device discovery service
        *
        * @customElement
        * @polymer
        * @demo demo/index.html
        */
        class BluetoothDeviceComponent extends Polymer.Element {
            static get is() { return 'bluetooth-device-component'; }
            static get properties() {
                return {
                    device: {
                        type: BluetoothDevice,
                        notify: true,
                        readOnly: true,
                        observer: '_deviceChanged'
                    },
                    supported: {
                        type: Boolean,
                        readOnly: true,
                        value: SUPPORTED
                    },
                    servicesFilter: {
                        type: Array,
                        observer: '_filterChanged'
                    },
                    nameFilter: {
                        type: String,
                        observer: '_filterChanged'
                    },
                    namePrefixFilter: {
                        type: String,
                        observer: '_filterChanged'
                    },
                    optionalServicesFilter: {
                        type: Array,
                        observer: '_filterChanged'
                    },
                };
            }

            request(){
                console.log(this.request.name);
                if(!this.supported) {
                    return Promise.reject(new Error('Your browser does not support Bluetooth'));
                }
                if(this.device){
                    this._deviceChanged();
                    return Promise.resolve(this.device);
                }
                let options = {
                    filters: []
                };
                if (this.servicesFilter) {
                    options
                        .filters.push({
                            services: this.servicesFilter
                        });
                }
                if (this.nameFilter) {
                options.filters.push({name: this.nameFilter});
                }
                if (this.namePrefixFilter) {
                options.filters.push({namePrefix: this.namePrefixFilter});
                }
                if (this.optionalServicesFilter) {
                options.optionalServices = this.optionalServicesFilter;
                }
                if (options.filters.length == 0) {
                    return Promise.reject(new Error('Please set Bluetooth options filters.'));
                }
                let self = this;
                return navigator.bluetooth.requestDevice(options)
                    .then((device) => {
                        self._setDevice(device);
                        return self.device;
                    });
            }

            _deviceChanged() {
                console.log(this._deviceChanged.name);
                // TBD
            }

            _filterChanged(){
                this._setDevice(null);
            }
        }
        window.customElements.define(BluetoothDeviceComponent.is, BluetoothDeviceComponent);
    })();
  </script>
</dom-module>
